{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
<style>
    .parameter-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .parameter-group {
        margin-bottom: 1.5rem;
    }
    
    .parameter-group h5 {
        color: var(--primary);
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .form-label {
        font-weight: 500;
        color: var(--dark);
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: border-color 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .training-controls {
        background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
    }
    
    .live-monitor {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .metric-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary);
    }
    
    .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .chart-container {
        height: 300px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-flask"></i>
                        {{ model.name }} Experiment
                    </h1>
                    <p class="text-muted mb-0">{{ purpose.name }} - {{ purpose.description }}</p>
                </div>
                <div>
                    <a href="/purpose/{{ purpose_name }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to {{ purpose.name }}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content - Parameters -->
        <div class="col-12">
            <!-- Model Information -->
            <div class="parameter-section">
                <h4><i class="fas fa-info-circle"></i> Model Information</h4>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Model:</strong> {{ model.name }}</p>
                        <p><strong>Paper:</strong> {{ model.paper }}</p>
                        <p><strong>Type:</strong> Graph Generation</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Architecture:</strong> {{ model.architecture }}</p>
                        <p><strong>Applications:</strong> {{ model.applications|join(', ') }}</p>
                    </div>
                </div>
            </div>

            <!-- Architecture Parameters -->
            <div class="parameter-section">
                <h4><i class="fas fa-cogs"></i> Architecture Parameters</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="hidden_dim" class="form-label">Hidden Dimension</label>
                            <input type="number" class="form-control" id="hidden_dim" name="hidden_dim" 
                                   value="64" min="16" max="512" step="16">
                            <div class="form-text">Dimension of hidden layers (16-512)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="num_layers" class="form-label">Number of Layers</label>
                            <input type="number" class="form-control" id="num_layers" name="num_layers" 
                                   value="3" min="1" max="10">
                            <div class="form-text">Number of GNN layers (1-10)</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="dropout" class="form-label">Dropout Rate</label>
                            <input type="number" class="form-control" id="dropout" name="dropout" 
                                   value="0.1" min="0.0" max="0.5" step="0.1">
                            <div class="form-text">Dropout rate for regularization (0.0-0.5)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="activation" class="form-label">Activation Function</label>
                            <select class="form-select" id="activation" name="activation">
                                <option value="relu">ReLU</option>
                                <option value="tanh">Tanh</option>
                                <option value="sigmoid">Sigmoid</option>
                                <option value="leaky_relu">Leaky ReLU</option>
                            </select>
                            <div class="form-text">Activation function for hidden layers</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="generation_method" class="form-label">Generation Method</label>
                            <select class="form-select" id="generation_method" name="generation_method">
                                <option value="autoregressive">Autoregressive</option>
                                <option value="vae">Variational Autoencoder</option>
                                <option value="gan">Generative Adversarial Network</option>
                                <option value="flow">Normalizing Flow</option>
                                <option value="diffusion">Diffusion Model</option>
                                <option value="transformer">Graph Transformer</option>
                                <option value="rnn">Recurrent Neural Network</option>
                                <option value="lstm">LSTM-based</option>
                            </select>
                            <div class="form-text">Graph generation approach</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="max_nodes" class="form-label">Maximum Nodes</label>
                            <input type="number" class="form-control" id="max_nodes" name="max_nodes" 
                                   value="50" min="10" max="1000" step="10">
                            <div class="form-text">Maximum number of nodes per graph (10-1000)</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="latent_dim" class="form-label">Latent Dimension</label>
                            <input type="number" class="form-control" id="latent_dim" name="latent_dim" 
                                   value="32" min="8" max="256" step="8">
                            <div class="form-text">Dimension of latent space (8-256)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="attention_heads" class="form-label">Attention Heads</label>
                            <input type="number" class="form-control" id="attention_heads" name="attention_heads" 
                                   value="4" min="1" max="16">
                            <div class="form-text">Number of attention heads for transformer models</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generation Parameters -->
            <div class="parameter-section">
                <h4><i class="fas fa-magic"></i> Generation Parameters</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="num_graphs" class="form-label">Number of Graphs to Generate</label>
                            <input type="number" class="form-control" id="num_graphs" name="num_graphs" 
                                   value="100" min="10" max="10000" step="10">
                            <div class="form-text">Number of graphs to generate (10-10000)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="generation_steps" class="form-label">Generation Steps</label>
                            <input type="number" class="form-control" id="generation_steps" name="generation_steps" 
                                   value="20" min="5" max="100">
                            <div class="form-text">Number of steps for iterative generation (5-100)</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="temperature" class="form-label">Sampling Temperature</label>
                            <input type="number" class="form-control" id="temperature" name="temperature" 
                                   value="1.0" min="0.1" max="2.0" step="0.1">
                            <div class="form-text">Temperature for sampling (0.1-2.0)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="top_k" class="form-label">Top-K Sampling</label>
                            <input type="number" class="form-control" id="top_k" name="top_k" 
                                   value="10" min="1" max="100">
                            <div class="form-text">Top-K value for sampling (1-100)</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="validity_weight" class="form-label">Validity Weight</label>
                            <input type="number" class="form-control" id="validity_weight" name="validity_weight" 
                                   value="1.0" min="0.0" max="10.0" step="0.1">
                            <div class="form-text">Weight for validity constraint (0.0-10.0)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="uniqueness_weight" class="form-label">Uniqueness Weight</label>
                            <input type="number" class="form-control" id="uniqueness_weight" name="uniqueness_weight" 
                                   value="0.5" min="0.0" max="5.0" step="0.1">
                            <div class="form-text">Weight for uniqueness constraint (0.0-5.0)</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="fidelity_weight" class="form-label">Fidelity Weight</label>
                            <input type="number" class="form-control" id="fidelity_weight" name="fidelity_weight" 
                                   value="0.8" min="0.0" max="5.0" step="0.1">
                            <div class="form-text">Weight for fidelity constraint (0.0-5.0)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="novelty_weight" class="form-label">Novelty Weight</label>
                            <input type="number" class="form-control" id="novelty_weight" name="novelty_weight" 
                                   value="0.3" min="0.0" max="5.0" step="0.1">
                            <div class="form-text">Weight for novelty constraint (0.0-5.0)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Training Parameters -->
            <div class="parameter-section">
                <h4><i class="fas fa-graduation-cap"></i> Training Parameters</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="learning_rate" class="form-label">Learning Rate</label>
                            <input type="number" class="form-control" id="learning_rate" name="learning_rate" 
                                   value="0.001" min="0.00001" max="0.1" step="0.0001">
                            <div class="form-text">Learning rate for optimization</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="epochs" class="form-label">Number of Epochs</label>
                            <input type="number" class="form-control" id="epochs" name="epochs" 
                                   value="100" min="10" max="1000">
                            <div class="form-text">Number of training epochs</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="batch_size" class="form-label">Batch Size</label>
                            <input type="number" class="form-control" id="batch_size" name="batch_size" 
                                   value="32" min="1" max="256">
                            <div class="form-text">Batch size for training</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="optimizer" class="form-label">Optimizer</label>
                            <select class="form-select" id="optimizer" name="optimizer">
                                <option value="adam">Adam</option>
                                <option value="sgd">SGD</option>
                                <option value="adamw">AdamW</option>
                                <option value="rmsprop">RMSprop</option>
                            </select>
                            <div class="form-text">Optimization algorithm</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="weight_decay" class="form-label">Weight Decay</label>
                            <input type="number" class="form-control" id="weight_decay" name="weight_decay" 
                                   value="0.0001" min="0.0" max="0.1" step="0.0001">
                            <div class="form-text">L2 regularization coefficient</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="scheduler" class="form-label">Learning Rate Scheduler</label>
                            <select class="form-select" id="scheduler" name="scheduler">
                                <option value="none">None</option>
                                <option value="step">Step LR</option>
                                <option value="cosine">Cosine Annealing</option>
                                <option value="plateau">Reduce on Plateau</option>
                            </select>
                            <div class="form-text">Learning rate scheduling strategy</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="patience" class="form-label">Early Stopping Patience</label>
                            <input type="number" class="form-control" id="patience" name="patience" 
                                   value="10" min="1" max="50">
                            <div class="form-text">Number of epochs to wait before early stopping</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="loss_function" class="form-label">Loss Function</label>
                            <select class="form-select" id="loss_function" name="loss_function">
                                <option value="mse">Mean Squared Error</option>
                                <option value="bce">Binary Cross Entropy</option>
                                <option value="kl_divergence">KL Divergence</option>
                                <option value="wasserstein">Wasserstein Loss</option>
                                <option value="adversarial">Adversarial Loss</option>
                                <option value="reconstruction">Reconstruction Loss</option>
                                <option value="combined">Combined Loss</option>
                            </select>
                            <div class="form-text">Loss function for graph generation</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dataset Configuration -->
            <div class="parameter-section">
                <h4><i class="fas fa-database"></i> Dataset Configuration</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="dataset" class="form-label">Dataset</label>
                            <select class="form-select" id="dataset" name="dataset">
                                <option value="qm9">QM9 (Quantum Chemistry)</option>
                                <option value="zinc">ZINC (Molecular Property)</option>
                                <option value="enzymes">ENZYMES (Protein Function)</option>
                                <option value="proteins">PROTEINS (Protein Function)</option>
                                <option value="nci1">NCI1 (Chemical Compounds)</option>
                                <option value="nci109">NCI109 (Chemical Compounds)</option>
                                <option value="mutag">MUTAG (Chemical Compounds)</option>
                                <option value="ptc">PTC (Chemical Compounds)</option>
                                <option value="collab">COLLAB (Scientific Collaboration)</option>
                                <option value="imdb_b">IMDB-B (Movie Reviews)</option>
                                <option value="imdb_m">IMDB-M (Movie Reviews)</option>
                                <option value="reddit_b">REDDIT-B (Social Networks)</option>
                                <option value="reddit_m">REDDIT-M (Social Networks)</option>
                            </select>
                            <div class="form-text">Select a graph dataset</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="graph_type" class="form-label">Graph Type</label>
                            <select class="form-select" id="graph_type" name="graph_type">
                                <option value="molecular">Molecular Graphs</option>
                                <option value="social">Social Networks</option>
                                <option value="biological">Biological Networks</option>
                                <option value="chemical">Chemical Compounds</option>
                                <option value="synthetic">Synthetic Graphs</option>
                                <option value="citation">Citation Networks</option>
                                <option value="coauthor">Co-authorship Networks</option>
                            </select>
                            <div class="form-text">Type of graphs to generate</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="validation_split" class="form-label">Validation Split</label>
                            <input type="number" class="form-control" id="validation_split" name="validation_split" 
                                   value="0.2" min="0.1" max="0.5" step="0.1">
                            <div class="form-text">Fraction of graphs for validation</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="test_split" class="form-label">Test Split</label>
                            <input type="number" class="form-control" id="test_split" name="test_split" 
                                   value="0.2" min="0.1" max="0.5" step="0.1">
                            <div class="form-text">Fraction of graphs for testing</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="evaluation_metric" class="form-label">Evaluation Metric</label>
                            <select class="form-select" id="evaluation_metric" name="evaluation_metric">
                                <option value="validity">Validity Rate</option>
                                <option value="uniqueness">Uniqueness</option>
                                <option value="novelty">Novelty</option>
                                <option value="fidelity">Fidelity</option>
                                <option value="diversity">Diversity</option>
                                <option value="coverage">Coverage</option>
                                <option value="combined">Combined Score</option>
                            </select>
                            <div class="form-text">Primary evaluation metric</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="parameter-group">
                            <label for="generation_mode" class="form-label">Generation Mode</label>
                            <select class="form-select" id="generation_mode" name="generation_mode">
                                <option value="conditional">Conditional Generation</option>
                                <option value="unconditional">Unconditional Generation</option>
                                <option value="guided">Guided Generation</option>
                                <option value="controlled">Controlled Generation</option>
                            </select>
                            <div class="form-text">Mode of graph generation</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Training Controls -->
            <div class="training-controls">
                <h4><i class="fas fa-play-circle"></i> Training Controls</h4>
                <div class="row">
                    <div class="col-md-4">
                        <button type="button" class="btn btn-success btn-lg w-100 mb-3" id="startTraining">
                            <i class="fas fa-play"></i> Start Training
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-danger btn-lg w-100 mb-3" id="stopTraining" disabled>
                            <i class="fas fa-stop"></i> Stop Training
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-warning btn-lg w-100 mb-3" id="resetTraining">
                            <i class="fas fa-redo"></i> Reset Training
                        </button>
                    </div>
                </div>
            </div>

            <!-- Live Training Monitor -->
            <div class="live-monitor" id="liveMonitor" style="display: none;">
                <h4><i class="fas fa-chart-line"></i> Live Training Monitor</h4>
                
                <!-- Training Progress -->
                <div class="mb-4">
                    <label class="form-label">Epoch Progress</label>
                    <div class="progress mb-2">
                        <div class="progress-bar" id="epochProgress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted" id="epochText">0 / 0 epochs</small>
                </div>

                <!-- Live Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="currentLoss">-</div>
                        <div class="metric-label">Training Loss</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="validationLoss">-</div>
                        <div class="metric-label">Validation Loss</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="currentValidity">-</div>
                        <div class="metric-label">Validity Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="currentUniqueness">-</div>
                        <div class="metric-label">Uniqueness</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="currentNovelty">-</div>
                        <div class="metric-label">Novelty</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="currentFidelity">-</div>
                        <div class="metric-label">Fidelity</div>
                    </div>
                </div>

                <!-- Training Charts -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="lossChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <canvas id="validityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-primary" id="saveModel">
                                <i class="fas fa-save"></i> Save Model
                            </button>
                            <button type="button" class="btn btn-outline-success" id="viewResults">
                                <i class="fas fa-chart-bar"></i> View Results
                            </button>
                            <button type="button" class="btn btn-outline-info" id="exportConfig">
                                <i class="fas fa-download"></i> Export Config
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    const lossCtx = document.getElementById('lossChart').getContext('2d');
    const validityCtx = document.getElementById('validityChart').getContext('2d');
    
    const lossChart = new Chart(lossCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Training Loss',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }, {
                label: 'Validation Loss',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Loss Over Time'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    const validityChart = new Chart(validityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Validity Rate',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                tension: 0.1
            }, {
                label: 'Uniqueness',
                data: [],
                borderColor: 'rgb(255, 159, 64)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Generation Quality Over Time'
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 1
                }
            }
        }
    });
    
    // Training state
    let isTraining = false;
    let currentEpoch = 0;
    let totalEpochs = 0;
    let trainingInterval;
    
    // Start training
    document.getElementById('startTraining').addEventListener('click', function() {
        if (isTraining) return;
        
        // Get parameters
        const parameters = {
            hidden_dim: parseInt(document.getElementById('hidden_dim').value),
            num_layers: parseInt(document.getElementById('num_layers').value),
            dropout: parseFloat(document.getElementById('dropout').value),
            activation: document.getElementById('activation').value,
            generation_method: document.getElementById('generation_method').value,
            max_nodes: parseInt(document.getElementById('max_nodes').value),
            latent_dim: parseInt(document.getElementById('latent_dim').value),
            attention_heads: parseInt(document.getElementById('attention_heads').value),
            learning_rate: parseFloat(document.getElementById('learning_rate').value),
            epochs: parseInt(document.getElementById('epochs').value),
            batch_size: parseInt(document.getElementById('batch_size').value),
            optimizer: document.getElementById('optimizer').value,
            weight_decay: parseFloat(document.getElementById('weight_decay').value),
            scheduler: document.getElementById('scheduler').value,
            patience: parseInt(document.getElementById('patience').value),
            loss_function: document.getElementById('loss_function').value,
            num_graphs: parseInt(document.getElementById('num_graphs').value),
            generation_steps: parseInt(document.getElementById('generation_steps').value),
            temperature: parseFloat(document.getElementById('temperature').value),
            top_k: parseInt(document.getElementById('top_k').value),
            validity_weight: parseFloat(document.getElementById('validity_weight').value),
            uniqueness_weight: parseFloat(document.getElementById('uniqueness_weight').value),
            fidelity_weight: parseFloat(document.getElementById('fidelity_weight').value),
            novelty_weight: parseFloat(document.getElementById('novelty_weight').value),
            dataset: document.getElementById('dataset').value,
            graph_type: document.getElementById('graph_type').value,
            validation_split: parseFloat(document.getElementById('validation_split').value),
            test_split: parseFloat(document.getElementById('test_split').value),
            evaluation_metric: document.getElementById('evaluation_metric').value,
            generation_mode: document.getElementById('generation_mode').value
        };
        
        // Start training simulation
        startTrainingSimulation(parameters);
    });
    
    // Stop training
    document.getElementById('stopTraining').addEventListener('click', function() {
        if (!isTraining) return;
        stopTraining();
    });
    
    // Reset training
    document.getElementById('resetTraining').addEventListener('click', function() {
        resetTraining();
    });
    
    function startTrainingSimulation(parameters) {
        isTraining = true;
        currentEpoch = 0;
        totalEpochs = parameters.epochs;
        
        // Update UI
        document.getElementById('startTraining').disabled = true;
        document.getElementById('stopTraining').disabled = false;
        document.getElementById('liveMonitor').style.display = 'block';
        
        // Simulate training
        trainingInterval = setInterval(() => {
            currentEpoch++;
            
            // Update progress
            const epochProgress = (currentEpoch / totalEpochs) * 100;
            document.getElementById('epochProgress').style.width = epochProgress + '%';
            document.getElementById('epochText').textContent = `${currentEpoch} / ${totalEpochs} epochs`;
            
            // Simulate metrics for graph generation
            const trainLoss = Math.max(0.1, 2.5 - (currentEpoch / totalEpochs) * 2.3);
            const valLoss = trainLoss + Math.random() * 0.3;
            const validity = Math.min(0.95, 0.1 + (currentEpoch / totalEpochs) * 0.8);
            const uniqueness = Math.min(0.9, 0.2 + (currentEpoch / totalEpochs) * 0.65);
            const novelty = Math.min(0.85, 0.3 + (currentEpoch / totalEpochs) * 0.5);
            const fidelity = Math.min(0.92, 0.4 + (currentEpoch / totalEpochs) * 0.48);
            
            // Update metrics
            document.getElementById('currentLoss').textContent = trainLoss.toFixed(4);
            document.getElementById('validationLoss').textContent = valLoss.toFixed(4);
            document.getElementById('currentValidity').textContent = (validity * 100).toFixed(1) + '%';
            document.getElementById('currentUniqueness').textContent = (uniqueness * 100).toFixed(1) + '%';
            document.getElementById('currentNovelty').textContent = (novelty * 100).toFixed(1) + '%';
            document.getElementById('currentFidelity').textContent = (fidelity * 100).toFixed(1) + '%';
            
            // Update charts
            lossChart.data.labels.push(currentEpoch);
            lossChart.data.datasets[0].data.push(trainLoss);
            lossChart.data.datasets[1].data.push(valLoss);
            lossChart.update();
            
            validityChart.data.labels.push(currentEpoch);
            validityChart.data.datasets[0].data.push(validity);
            validityChart.data.datasets[1].data.push(uniqueness);
            validityChart.update();
            
            // Check if training is complete
            if (currentEpoch >= totalEpochs) {
                stopTraining(true); // true indicates natural completion
            }
        }, 100); // Update every 100ms for smooth animation
    }
    
    function stopTraining(isCompleted = false, isReset = false) {
        isTraining = false;
        clearInterval(trainingInterval);
        
        // Update UI
        document.getElementById('startTraining').disabled = false;
        document.getElementById('stopTraining').disabled = true;
        
        // Show appropriate notification
        if (isReset) {
            showNotification('Training reset', 'info');
        } else if (isCompleted) {
            showNotification('Training completed successfully!', 'success');
        } else {
            showNotification('Training stopped', 'warning');
        }
    }
    
    function resetTraining() {
        stopTraining(false, true); // Pass isReset = true
        
        // Reset charts
        lossChart.data.labels = [];
        lossChart.data.datasets[0].data = [];
        lossChart.data.datasets[1].data = [];
        lossChart.update();
        
        validityChart.data.labels = [];
        validityChart.data.datasets[0].data = [];
        validityChart.data.datasets[1].data = [];
        validityChart.update();
        
        // Reset progress
        document.getElementById('epochProgress').style.width = '0%';
        document.getElementById('epochText').textContent = '0 / 0 epochs';
        document.getElementById('liveMonitor').style.display = 'none';
        
        // Reset metrics
        document.getElementById('currentLoss').textContent = '-';
        document.getElementById('currentValidity').textContent = '-';
        document.getElementById('validationLoss').textContent = '-';
        document.getElementById('currentUniqueness').textContent = '-';
        document.getElementById('currentFidelity').textContent = '-';
        document.getElementById('currentNovelty').textContent = '-';
    }
    
    function showNotification(message, type = 'info') {
        if (window.GNNPlatform && window.GNNPlatform.showNotification) {
            window.GNNPlatform.showNotification(message, type);
        } else {
            alert(message);
        }
    }
    
    // Quick action handlers
    document.getElementById('saveModel').addEventListener('click', function() {
        showNotification('Model saved successfully!', 'success');
    });
    
    document.getElementById('viewResults').addEventListener('click', function() {
        window.location.href = `/purpose/{{ purpose_name }}/results/${model_id}`;
    });
    
    document.getElementById('exportConfig').addEventListener('click', function() {
        const config = {
            model: '{{ model_id }}',
            purpose: '{{ purpose_name }}',
            parameters: {
                hidden_dim: document.getElementById('hidden_dim').value,
                num_layers: document.getElementById('num_layers').value,
                dropout: document.getElementById('dropout').value,
                activation: document.getElementById('activation').value,
                generation_method: document.getElementById('generation_method').value,
                max_nodes: document.getElementById('max_nodes').value,
                latent_dim: document.getElementById('latent_dim').value,
                attention_heads: document.getElementById('attention_heads').value,
                learning_rate: document.getElementById('learning_rate').value,
                epochs: document.getElementById('epochs').value,
                batch_size: document.getElementById('batch_size').value,
                optimizer: document.getElementById('optimizer').value,
                weight_decay: document.getElementById('weight_decay').value,
                scheduler: document.getElementById('scheduler').value,
                patience: document.getElementById('patience').value,
                loss_function: document.getElementById('loss_function').value,
                num_graphs: document.getElementById('num_graphs').value,
                generation_steps: document.getElementById('generation_steps').value,
                temperature: document.getElementById('temperature').value,
                top_k: document.getElementById('top_k').value,
                validity_weight: document.getElementById('validity_weight').value,
                uniqueness_weight: document.getElementById('uniqueness_weight').value,
                fidelity_weight: document.getElementById('fidelity_weight').value,
                novelty_weight: document.getElementById('novelty_weight').value,
                dataset: document.getElementById('dataset').value,
                graph_type: document.getElementById('graph_type').value,
                validation_split: document.getElementById('validation_split').value,
                test_split: document.getElementById('test_split').value,
                evaluation_metric: document.getElementById('evaluation_metric').value,
                generation_mode: document.getElementById('generation_mode').value
            }
        };
        
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gnn_config_${model_id}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('Configuration exported successfully!', 'success');
    });
});
</script>
{% endblock %}
